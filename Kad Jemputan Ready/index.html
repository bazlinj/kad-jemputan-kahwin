<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jemputan ke Majlis Perkahwinan</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Poppins:wght@400;500;600&family=Tangerine:wght@700&family=Scheherazade+New:wght@700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Poppins', sans-serif; background-color: #e2e8f0; }
        .font-playfair { font-family: 'Playfair Display', serif; }
        .font-script { font-family: 'Tangerine', cursive; }
        .font-arabic { font-family: 'Scheherazade New', serif; }

        .app-wrapper {
            max-width: 420px;
            margin: auto;
            position: relative;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            min-height: 100vh;
            overflow: hidden;
            background-color: #f8fafc;
        }

        #app-video-bg {
            position: absolute;
            top: 50%;
            left: 50%;
            width: auto;
            height: auto;
            min-width: 100%;
            min-height: 100%;
            z-index: 1;
            transform: translateX(-50%) translateY(-50%);
            object-fit: cover;
            transition: opacity 1s ease-in;
            opacity: 0;
        }

        .page { position: absolute; inset: 0; z-index: 10; visibility: hidden; opacity: 0; transition: visibility 0.4s, opacity 0.4s ease; overflow-y: auto; background-color: transparent;}
        .page.active { visibility: visible; opacity: 1; z-index: 20; }
        
        .drawer { position: fixed; inset: 0; z-index: 50; visibility: hidden; }
        .drawer.active { visibility: visible; }
        .drawer-backdrop { position: absolute; inset: 0; background-color: rgba(0,0,0,0.5); opacity: 0; transition: opacity 0.3s ease; }
        .drawer.active .drawer-backdrop { opacity: 1; }
        .drawer-content { 
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            margin: 0 auto;
            max-width: 420px;
            background-color: white;
            border-radius: 1.5rem 1.5rem 0 0;
            transform: translateY(100%);
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            max-height: 80vh;
            display: flex;
            flex-direction: column;
            padding-bottom: env(safe-area-inset-bottom); /* Added safe area padding */
        }
        .drawer.active .drawer-content { transform: translateY(0); }

        .bottom-nav-btn.active { color: #2563EB; }
        
        .ucapan-bg { background-size: cover; background-position: center; background-image: linear-gradient(rgba(255, 255, 255, 0.85), rgba(255, 255, 255, 0.85)), url('https://img.freepik.com/free-photo/top-view-floral-arrangement-with-copy-space_23-2148427829.jpg'); }
        .chat-bubble { background-color: #ffffff; border-radius: 0.75rem; padding: 0.75rem 1rem; box-shadow: 0 1px 2px rgba(0,0,0,0.08); max-width: 85%; word-wrap: break-word; transition: background-color 0.3s ease; }
        
        .toast { position: fixed; bottom: -100px; left: 50%; transform: translateX(-50%); background-color: rgba(0,0,0,0.7); color: white; padding: 10px 20px; border-radius: 9999px; z-index: 100; transition: bottom 0.5s ease-in-out; }
        .toast.show { bottom: 80px; }
        
        .spinner { border: 2px solid rgba(255,255,255,0.3); border-radius: 50%; border-top: 2px solid #fff; width: 20px; height: 20px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        @keyframes music-bars { 0% { transform: scaleY(0.3); } 25% { transform: scaleY(1); } 50% { transform: scaleY(0.5); } 75% { transform: scaleY(0.8); } 100% { transform: scaleY(0.3); } }
        .music-playing path { animation: music-bars 1.2s infinite ease-in-out; transform-origin: center; }
        .music-playing path:nth-child(2) { animation-delay: 0.2s; }
        .music-playing path:nth-child(3) { animation-delay: 0.4s; }
        .music-playing path:nth-child(4) { animation-delay: 0.1s; }
        .music-playing path:nth-child(5) { animation-delay: 0.5s; }
        .music-playing path:nth-child(6) { animation-delay: 0.3s; }
        
        .floating-hearts { position: absolute; top: 0; left: 0; width: 100%; height: 100%; overflow: hidden; z-index: 1; pointer-events: none;}
        .heart { position: absolute; color: rgba(255, 255, 255, 0.7); animation: float 15s infinite; opacity: 0; }
        @keyframes float { 0% { transform: translateY(100vh) scale(0.5); opacity: 0; } 10% { opacity: 0.7; } 90% { opacity: 0.7; } 100% { transform: translateY(-10vh) scale(1); opacity: 0; } }

        .fade-in-up { opacity: 0; transform: translateY(20px); transition: opacity 0.6s ease-out, transform 0.6s ease-out; }
        .fade-in-up.is-visible { opacity: 1; transform: translateY(0); }

        .smooth-zoom-bg { animation: smooth-zoom-animation 30s infinite alternate ease-out; }
        @keyframes smooth-zoom-animation { 0% { transform: scale(1); } 100% { transform: scale(1.15); } }

        .gem-shining { animation: shine 2s infinite linear; }
        @keyframes shine { 0%, 100% { transform: scale(1); opacity: 0.7; } 50% { transform: scale(1.15); opacity: 1; filter: drop-shadow(0 0 8px #93c5fd); } }
        
        .glass-card {
            background-color: rgba(255, 255, 255, 0.6);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-radius: 1rem;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.1);
        }
        
        .sheen-button { position: relative; overflow: hidden; }
        .sheen-button::after { content: ''; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%; background: linear-gradient(to right, rgba(255, 255, 255, 0) 0%, rgba(255, 255, 255, 0.5) 50%, rgba(255, 255, 255, 0) 100%); transform: rotate(45deg) translateX(-150%); transition: transform 0.8s ease; }
        .sheen-button:hover::after { transform: rotate(45deg) translateX(150%); }
    </style>
</head>
<body>
<div class="app-wrapper">
    <video autoplay loop muted playsinline id="app-video-bg"></video>
    <div id="cover-page-wrapper" class="absolute inset-0 z-[100] flex items-center justify-center p-4 transition-opacity duration-1000">
        <div id="cover-page" class="relative w-full max-w-sm flex flex-col items-center justify-center text-center p-8 glass-card">
              <div id="cover-content" class="text-slate-800 opacity-0 transition-opacity duration-1000 delay-500">
                  <h3 class="font-arabic text-2xl mb-4">بِسْمِ اللَّهِ الرَّحْمَنِ الرَّحِيم</h3>
                  <p class="mb-4 text-sm leading-relaxed">Dengan penuh kesyukuran,<br><strong class="font-semibold">Tengku Azelan Shah Tengku Ibrahim & Safiah Ismail</strong><br>ingin menjemput<br>Tan Sri / Dato' / Tuan / Puan / Saudara / Saudari</p>
                  <p class="mb-6 text-sm">ke Majlis Perkahwinan Putera kami bersama Pasangannya.</p>
                  <h1 id="cover-groom" class="font-script text-5xl leading-tight whitespace-nowrap"></h1>
                  <h2 class="font-script text-4xl my-1">&</h2>
                  <h1 id="cover-bride" class="font-script text-5xl leading-tight whitespace-nowrap"></h1>
                   <button id="open-invitation-btn" class="sheen-button mt-8 bg-blue-600 text-white font-bold py-3 px-8 rounded-full shadow-lg hover:bg-blue-700 transition-all transform hover:scale-105">
                       Buka Jemputan
                   </button>
              </div>
              <div id="cover-loading" class="text-slate-700">
                  <p>Anda telah dijemput...</p>
                  <div class="spinner border-slate-700/30 border-t-slate-700 mx-auto mt-4"></div>
              </div>
        </div>
    </div>
    
    <div id="app-container" class="opacity-0 transition-opacity duration-1000">
        <main id="main-content-area" class="relative min-h-screen"></main>
        <nav id="bottom-nav" class="fixed bottom-0 left-0 right-0 max-w-md mx-auto bg-white/95 backdrop-blur-sm shadow-[0_-2px_10px_rgba(0,0,0,0.05)] z-[60] rounded-t-2xl transition-transform duration-300">
            <div class="flex justify-around">
                <button data-page="utama" class="bottom-nav-btn active flex-1 flex flex-col items-center justify-center p-3 text-slate-600 transition-colors"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path></svg></button>
                <button data-page="lokasi" class="bottom-nav-btn flex-1 flex flex-col items-center justify-center p-3 text-slate-600 transition-colors"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path></svg></button>
                <button data-page="ucapan" class="bottom-nav-btn flex-1 flex flex-col items-center justify-center p-3 text-slate-600 transition-colors"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path></svg></button>
                <button data-drawer="hadiah" class="bottom-nav-btn flex-1 flex flex-col items-center justify-center p-3 text-slate-600 transition-colors"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v13m0-13V6a2 2 0 112 2h-2zm0 0V5.5A2.5 2.5 0 109.5 8H12zm-7 4h14M5 12a2 2 0 110-4h14a2 2 0 110 4M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"></path></svg></button>
                <button data-drawer="telefon" class="bottom-nav-btn flex-1 flex flex-col items-center justify-center p-3 text-slate-600 transition-colors"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z" /></svg></button>
            </div>
        </nav>
    </div>
    
    <div id="drawers-container"></div>
    <div id="audio-player" class="w-0 h-0 overflow-hidden"></div>
    <div id="toast" class="toast"></div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- KONFIGURASI ---
        const SCRIPT_URL = '/.netlify/functions/submit';
        const DATA_URL = 'https://script.google.com/macros/s/AKfycbyaEfnvqAbf0XAyu2av1ktLEJ2FgU60IEziTA7RzwpXvaGb_ZVcnTr244rFNMeU3DaF/exec';
        const WISHES_PER_PAGE = 10;
        let mainData = {};
        const giftLinkData = [
            { name: "Touch 'n Go e-Wallet", logo: "https://upload.wikimedia.org/wikipedia/commons/thumb/f/fb/Touch_%27n_Go_eWallet_logo.svg/2024px-Touch_%27n_Go_eWallet_logo.svg.png", url: "https://visit.tngdigital.com.my/Gift" },
            { name: "Grab Gifts", logo: "https://1000logos.net/wp-content/uploads/2022/08/Grab-Logo.png", url: "https://gifts.grab.com/my/" },
            { name: "Setel Voucher", logo: "https://images.crunchbase.com/image/upload/c_pad,f_auto,q_auto:eco,dpr_1/05e9b2407d294b538fd9e646c143b588", url: "https://www.setel.com/PETRONAS-Shop/product/setel-voucher" },
            { name: "Shopee Gift Card", logo: "https://upload.wikimedia.org/wikipedia/commons/thumb/0/0e/Shopee_logo.svg/2560px-Shopee_logo.svg.png", url: "https://www.seagm.com/en-my/shopee-cash-e-voucher" },
            { name: "Zus Coffee Gift Card", logo: "https://judgeme.imgix.net/g/unknown/1656878258__Full_Colour_450x_4a385410-999f-4d5b-9906-8c3555724456__original.png", url: "https://www.seagm.com/zus-coffee-cash-voucher-my" },
            { name: "Harvey Norman e-Gift Card", logo: "https://devicenetwork.s3.eu-west-2.amazonaws.com/images/logo/0wsxe7n.png", url: "https://www.harveynorman.com.my/gift-cards/harvey-norman-e-gift-card.html" },
            { name: "Klook Gift Card", logo: "https://1000logos.net/wp-content/uploads/2023/11/Klook-Logo.png", url: "https://www.klook.com/en-MY/klook-gift-card/" },
            { name: "Malaysia Airlines Gift Card", logo: "https://www.flightaware.com/images/airline_logos/180px/MAS.png", url: "https://vouchers.malaysiaairlines.com/en-gb/gift-cards/wedding-gift-card" }
        ];
        
        let state = { rsvpChart: null, currentWishesPage: 1, countdownInterval: null, audioPlayer: null, timeAgoInterval: null, isMusicPlaying: false, galleryInterval: null };
        let scrollObserver;
        let pendingWishes = [];
        let pendingRSVPs = [];
        let isOnline = navigator.onLine;
        let invitationOpened = false;
        
        const mainContentArea = document.getElementById('main-content-area');
        const drawersContainer = document.getElementById('drawers-container');
        
        const createPage = (id, content, extraClasses = '') => {
            return `<section id="page-${id}" class="page ${extraClasses}"><div class="page-content">${content}</div></section>`;
        };
        const createDrawer = (id, title, content, footerContent = '') => {
            const scrollPadding = footerContent ? 'pb-24' : 'pb-6';
            return `<div id="drawer-${id}" class="drawer"><div class="drawer-backdrop"></div><div class="drawer-content"><button class="drawer-close absolute top-4 right-4 text-gray-400 hover:text-gray-800 text-2xl">&times;</button><h2 class="font-playfair text-2xl pt-6 mb-4 text-center flex-shrink-0">${title}</h2><div class="flex-grow overflow-y-auto px-6 ${scrollPadding}">${content}</div>${footerContent}</div></div>`;
        };

        const init = () => {
            setupYouTubeAPI();
            const coverVideo = document.getElementById('app-video-bg');
            if (coverVideo) {
                coverVideo.src = "https://nazrin-serena.netlify.app/media/wallpaper.mp4";
                coverVideo.oncanplay = () => {
                    setTimeout(() => { coverVideo.style.opacity = '1'; }, 500); 
                };
            }
            fetchWithCache();
            pendingWishes = loadPendingItems('pendingWishes');
            pendingRSVPs = loadPendingItems('pendingRSVPs');
            window.addEventListener('online', () => { isOnline = true; });
            window.addEventListener('offline', () => { isOnline = false; });
        };

        const fetchWithCache = async () => {
            const cached = loadDataFromCache();
            if (cached) {
                mainData = cached;
                displayCoverPage();
            }
            try {
                const response = await fetch(DATA_URL);
                if (!response.ok) throw new Error('Network response was not ok.');
                const freshData = await response.json();
                if (!cached || !cached.lastUpdated || (new Date(freshData.lastUpdated) > new Date(cached.lastUpdated))) {
                    mainData = freshData;
                    saveDataToCache(mainData);
                }
                if (document.getElementById('app-container').classList.contains('opacity-0')) {
                    displayCoverPage();
                } else {
                    updateAllUI();
                }
            } catch (error) {
                console.error('Error fetching fresh data:', error);
                if (!cached) {
                    document.getElementById('cover-loading').innerHTML = '<p class="text-red-500">Gagal memuatkan data. Sila periksa sambungan internet anda.</p>';
                }
            }
        };

        const displayCoverPage = () => {
            const settings = mainData.TextSettings[0];
            document.getElementById('cover-groom').textContent = settings.GroomName;
            document.getElementById('cover-bride').textContent = settings.BrideName;
            document.getElementById('cover-loading').style.display = 'none';
            document.getElementById('cover-content').classList.remove('opacity-0');
            document.getElementById('open-invitation-btn').addEventListener('click', openInvitation, { once: true });
            
            const audioSongId = mainData.Song?.[0]?.YoutubeID;
            if (audioSongId && !state.audioPlayer) {
                if (window.YT && window.YT.Player) {
                     createAudioPlayer(audioSongId);
                }
            }
        };
        
        const openInvitation = () => {
            invitationOpened = true;
            document.getElementById('cover-page-wrapper').style.opacity = '0';
            setTimeout(() => {
                document.getElementById('cover-page-wrapper').style.display = 'none';
            }, 1000);
            
            document.getElementById('app-container').classList.remove('opacity-0');
            
            renderAppContent();
            setActivePage('utama');

            if (state.audioPlayer && typeof state.audioPlayer.playVideo === 'function' && state.audioPlayer.getPlayerState() !== 1) {
                state.audioPlayer.unMute();
                state.audioPlayer.playVideo();
            }
        };

        const renderAppContent = () => {
            const settings = mainData.TextSettings[0];
            const galleryImages = mainData.Gallery || [];
            
            const galleryHTML = galleryImages.length > 0 ? `
                <div class="glass-card p-4 fade-in-up">
                    <div class="gallery-container relative w-full h-64 overflow-hidden rounded-lg">
                        ${galleryImages.map((img, index) => `<img src="${img.ImageURL}" class="gallery-item absolute w-full h-full object-cover transition-opacity duration-1000" style="opacity: ${index === 0 ? 1 : 0};">`).join('')}
                        <button class="gallery-prev absolute top-1/2 left-2 -translate-y-1/2 bg-black/30 text-white rounded-full p-1 z-10 hover:bg-black/50 transition"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="m14 16-4-4 4-4"/></svg></button>
                        <button class="gallery-next absolute top-1/2 right-2 -translate-y-1/2 bg-black/30 text-white rounded-full p-1 z-10 hover:bg-black/50 transition"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="m10 8 4 4-4 4"/></svg></button>
                    </div>
                </div>
            ` : '';

            mainContentArea.innerHTML = `
                ${createPage('utama', `
                    <div class="p-4 space-y-6 pb-24">
                        <div class="relative h-96 rounded-2xl overflow-hidden shadow-xl fade-in-up">
                            <div class="absolute inset-0 bg-cover bg-center" style="background-image: url('${mainData.HeroImages[0]?.Utama}')">
                                <div class="absolute inset-0 smooth-zoom-bg" style="background-image: inherit; background-position: center; background-size: cover;"></div>
                            </div>
                            <div class="absolute inset-0 bg-gradient-to-t from-black/60 to-transparent flex flex-col items-center justify-center text-center p-6 text-white z-10">
                                <div class="floating-hearts"></div>
                                <h1 class="font-script text-5xl leading-tight">${settings.GroomName}</h1>
                                <h2 class="font-script text-4xl my-1">&</h2>
                                <h1 class="font-script text-5xl leading-tight">${settings.BrideName}</h1>
                            </div>
                        </div>
                        <div class="glass-card p-6 text-center fade-in-up">
                             <h2 class="font-playfair text-2xl text-slate-800">Menghitung Hari</h2>
                              <p class="mb-6 text-m">${settings.EventDate}</p>
                             <div id="countdown" class="flex justify-center space-x-4 mt-4 text-slate-600"></div>
                         </div>
                        ${galleryHTML}
                        <div class="glass-card p-6 text-center fade-in-up">
                            <h2 class="font-playfair text-2xl text-slate-800 mb-4">Sahkan Kehadiran Anda</h2>
                            <button id="open-rsvp-btn" class="sheen-button bg-blue-600 text-white font-bold py-3 px-8 rounded-full shadow-lg hover:bg-blue-700 transition-all transform hover:scale-105">Sahkan Kehadiran</button>
                        </div>
                        <div class="glass-card p-6 fade-in-up">
                            <div class="text-center">
                                <h2 class="font-playfair text-2xl text-slate-800">Ringkasan Kehadiran</h2>
                                <div class="my-2 flex justify-center">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="gem-shining text-blue-400">
                                        <path d="M6 3h12l4 6-10 13L2 9Z"/><path d="M11 3 8 9l4 13 4-13-3-6"/><path d="M2 9h20"/>
                                    </svg>
                                </div>
                                <div class="max-w-xs mx-auto"><canvas id="rsvpChart"></canvas></div>
                            </div>
                        </div>
                         <div class="glass-card p-4 text-center fade-in-up">
                             <button id="toggle-music-btn" class="w-full flex items-center justify-center space-x-2 py-2">
                                 <svg id="music-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-blue-600"><path d="M2 10v3"/><path d="M6 6v11"/><path d="M10 3v18"/><path d="M14 8v7"/><path d="M18 5v13"/><path d="M22 10v3"/></svg>
                                 <span id="music-btn-text" class="font-semibold text-slate-700"></span>
                             </button>
                         </div>
                    </div>
                `)}
                ${createPage('lokasi', `
                    <div class="p-4 space-y-6 pb-24">
                         <div class="relative h-48 rounded-2xl overflow-hidden shadow-lg fade-in-up">
                            <div class="absolute inset-0 bg-cover bg-center" style="background-image: url('${mainData.HeroImages[0]?.Lokasi}')">
                                <div class="absolute inset-0 smooth-zoom-bg" style="background-image: inherit; background-position: center; background-size: cover;"></div>
                            </div>
                            <div class="absolute inset-0 bg-black/40 flex items-center justify-center"><h1 class="font-playfair text-4xl text-white">Lokasi Majlis</h1></div>
                        </div>
                        <div class="glass-card p-6 fade-in-up">
                            <h2 class="font-semibold text-lg text-slate-800 mb-4 text-center">Aturcara Majlis</h2>
                            <div class="space-y-3 text-left text-slate-700">
                                <p><strong>Tarikh:</strong> ${settings.EventDate}</p>
                                <p><strong>Masa:</strong> ${settings.EventTime}</p>
                                <p><strong>Tempat:</strong> ${settings.VenueName}</p>
                                <p class="text-sm text-slate-500 mt-2">${settings.VenueAddress}</p>
                            </div>
                             <a href="${generateCalendarLink()}" target="_blank" class="mt-4 inline-flex items-center justify-center w-full space-x-2 bg-slate-100/50 text-slate-700 px-4 py-3 rounded-lg font-semibold hover:bg-slate-200/70 transition"><span>+ Tambah ke Kalendar</span></a>
                        </div>
                        <div class="glass-card p-4 fade-in-up">
                            <div class="w-full h-64 rounded-xl overflow-hidden shadow-inner">
                               <iframe width="100%" height="100%" frameborder="0" scrolling="no" marginheight="0" marginwidth="0" src="https://maps.google.com/maps?q=${encodeURIComponent(settings.VenueAddress)}&t=&z=16&ie=UTF8&iwloc=B&output=embed"></iframe>
                            </div>
                            <div class="mt-4 flex justify-center space-x-4">
                                <a href="${settings.GoogleMapsLink}" target="_blank" class="inline-flex items-center space-x-2 bg-blue-100/70 text-blue-800 px-5 py-2 rounded-full font-semibold hover:bg-blue-200/70 transition"><span>Google Maps</span></a>
                                <a href="${settings.WazeLink}" target="_blank" class="inline-flex items-center space-x-2 bg-blue-100/70 text-blue-800 px-5 py-2 rounded-full font-semibold hover:bg-blue-200/70 transition"><span>Waze</span></a>
                            </div>
                        </div>
                    </div>
                `)}
                 ${createPage('ucapan', `
                    <div class="flex flex-col h-screen">
                        <div id="wishes-list" class="flex-grow overflow-y-auto space-y-4 p-4 pb-32"></div> <!-- Changed pb-24 to pb-32 -->
                        <div id="wishes-pagination" class="py-2 flex justify-center flex-shrink-0"></div>
                        <div class="fixed bottom-24 left-0 right-0 max-w-md mx-auto p-4 pt-0 z-10 pb-[env(safe-area-inset-bottom)]"> <!-- Changed bottom-16 to bottom-24 and added safe area -->
                            <form id="wish-form" class="space-y-2 bg-white/80 backdrop-blur-sm p-3 rounded-2xl shadow-lg">
                                 <input type="text" id="wish-name-input" placeholder="Nama Anda" class="w-full px-4 py-2 border border-slate-200 rounded-lg bg-slate-50 focus:ring-2 focus:ring-blue-500 outline-none">
                                 <div class="flex items-center space-x-2">
                                     <input type="text" id="wish-input" placeholder="Tulis ucapan anda..." class="w-full px-4 py-2 border border-slate-200 rounded-lg bg-slate-50 focus:ring-2 focus:ring-blue-500 outline-none">
                                     <button type="submit" class="bg-green-500 text-white w-12 h-12 flex-shrink-0 flex items-center justify-center rounded-full transition transform hover:scale-110">
                                         <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor"><path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.428A1 1 0 009 15.571V11a1 1 0 112 0v4.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z" /></svg>
                                     </button>
                                 </div>
                            </form>
                        </div>
                    </div>
                `, 'ucapan-bg')}
                ${createPage('rsvp', `
                    <button id="close-rsvp-page" class="absolute top-4 right-4 text-gray-500 hover:text-gray-800 text-3xl z-10">&times;</button>
                    <div class="p-6">
                        <div class="text-center mb-6">
                            <h1 class="font-playfair text-3xl">Sahkan Kehadiran</h1>
                            <p class="text-slate-500 mt-2">Sila lengkapkan maklumat di bawah.</p>
                        </div>
                        <form id="rsvpForm" class="space-y-6">
                            <div><label class="font-semibold text-slate-700">Nama Anda</label><input type="text" name="Name" class="mt-2 w-full px-4 py-3 border border-slate-300 rounded-lg bg-white" required placeholder="Cth: Ali & Keluarga"></div>
                            <div><label class="font-semibold text-slate-700">Nombor Telefon</label><input type="tel" name="PhoneNumber" class="mt-2 w-full px-4 py-3 border border-slate-300 rounded-lg bg-white" required placeholder="Cth: 0123456789"></div>
                            <div><label class="font-semibold text-slate-700">Status Kehadiran</label><div class="flex items-center justify-center space-x-4 pt-3"><label class="flex items-center space-x-2 text-lg"><input type="radio" name="Attendance" value="Hadir" class="h-5 w-5 text-green-500" required><span>Hadir</span></label><label class="flex items-center space-x-2 text-lg"><input type="radio" name="Attendance" value="Tidak Hadir" class="h-5 w-5 text-red-500"><span>Tidak Hadir</span></label></div></div>
                            <div id="pax-section" class="hidden"><label class="font-semibold text-slate-700">Bilangan Kehadiran</label><select name="Pax" class="mt-2 w-full px-4 py-3 border border-slate-300 rounded-lg bg-white"><option value="">Sila Pilih</option>${[...Array(10).keys()].map(i => `<option value="${i+1}">${i+1} orang</option>`).join('')}</select></div>
                            <div><label class="font-semibold text-slate-700">Ucapan (Pilihan)</label><textarea name="Wishes" rows="3" class="mt-2 w-full px-4 py-3 border border-slate-300 rounded-lg bg-white" placeholder="Tulis ucapan anda di sini..."></textarea></div>
                            <div><button type="submit" class="w-full bg-blue-600 text-white font-bold py-3 px-6 rounded-lg transition hover:bg-blue-700 flex items-center justify-center">Sahkan</button></div>
                        </form>
                         <div id="rsvp-response" class="hidden mt-6 text-center"></div>
                     </div>
                `, 'bg-white')}
            `;

            const giftFooter = `
                <div class="p-4 text-center border-t border-slate-200 flex-shrink-0">
                     <p class="text-xs text-slate-500">Gunakan info ini semasa pembelian Kad Hadiah</p>
                     <p class="text-sm text-slate-700 mt-1">${mainData.GiftInfo[0].RecipientName} <span class="font-semibold">${mainData.GiftInfo[0].RecipientPhoneNumber}</span></p>
                <br></br></div>`;

            drawersContainer.innerHTML = `
                ${createDrawer('hadiah', 'Hadiah Perkahwinan', `<div id="gift-list" class="space-y-3"></div>`, giftFooter)}
                ${createDrawer('telefon', 'Hubungi Kami', `<div id="contact-list" class="space-y-4 pb-10"></div>`)} 
            `;
            
            updateAllUI();
            setupAllEventListeners();
        };
        
        const saveDataToCache = (data) => {
            localStorage.setItem('wedding_data', JSON.stringify({ ...data, lastUpdated: new Date().toISOString() }));
        };
        const loadDataFromCache = () => {
            return JSON.parse(localStorage.getItem('wedding_data'));
        };
        const savePendingItems = (key, items) => {
            localStorage.setItem(key, JSON.stringify(items));
        };
        const loadPendingItems = (key) => {
            return JSON.parse(localStorage.getItem(key)) || [];
        };
        const updateAllUI = () => {
            startCountdown();
            updateRsvpData();
            renderGiftList();
            renderContactList();
            setupScrollAnimations(document.body);
            createFloatingHearts();
            setupGallery();
        };
        const setupAllEventListeners = () => {
            setupNavAndDrawers();
            setupRsvpForm();
            setupMusicToggleButton();
            setupWishForm();
        };
        const setActivePage = (pageId) => {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            const newPage = document.getElementById(`page-${pageId}`);
            if(newPage) newPage.classList.add('active');
            document.querySelectorAll('.bottom-nav-btn[data-page]').forEach(b => b.classList.toggle('active', b.dataset.page === pageId));
            document.getElementById('bottom-nav').style.transform = (pageId === 'rsvp') ? 'translateY(100%)' : 'translateY(0)';
            if(pageId === 'ucapan') {
                const lastPage = Math.ceil((mainData.RSVP.length + mainData.WishesOnly.length) / WISHES_PER_PAGE) || 1;
                renderWishes(lastPage, true);
            }
        };
        const openDrawer = (drawerId) => {
            document.getElementById(`drawer-${drawerId}`)?.classList.add('active');
        };
        const closeDrawer = (drawer) => {
            drawer.classList.remove('active');
        };
        const setupNavAndDrawers = () => {
            document.querySelectorAll('.bottom-nav-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const target = e.currentTarget;
                    if (target.dataset.page) {
                        setActivePage(target.dataset.page);
                    } else if (target.dataset.drawer) {
                        openDrawer(target.dataset.drawer);
                    }
                });
            });
            drawersContainer.addEventListener('click', (e) => {
                if(e.target.classList.contains('drawer-backdrop') || e.target.classList.contains('drawer-close')) {
                    closeDrawer(e.target.closest('.drawer'));
                }
            });
            document.getElementById('open-rsvp-btn')?.addEventListener('click', () => setActivePage('rsvp'));
            document.getElementById('close-rsvp-page')?.addEventListener('click', () => setActivePage('utama'));
        };
        const updateMusicButtonState = () => {
            const musicIcon = document.getElementById('music-icon');
            const musicBtnText = document.getElementById('music-btn-text');
            if (!musicIcon || !musicBtnText) return;
            if (state.isMusicPlaying) {
                musicBtnText.textContent = 'Hentikan Muzik Latar';
                musicIcon.classList.add('music-playing');
            } else {
                musicBtnText.textContent = 'Mainkan Muzik Latar';
                musicIcon.classList.remove('music-playing');
            }
        };
        const setupMusicToggleButton = () => {
            const musicBtn = document.getElementById('toggle-music-btn');
            musicBtn?.addEventListener('click', () => {
                if (!state.audioPlayer) {
                    showToast('Sistem muzik sedang dimuatkan...');
                    return;
                }
                if (state.isMusicPlaying) {
                    state.audioPlayer.pauseVideo();
                } else {
                    state.audioPlayer.playVideo();
                }
            });
            updateMusicButtonState();
        };
        const showToast = (message) => {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        };
        const setupScrollAnimations = (container) => {
            const elements = container.querySelectorAll('.fade-in-up');
            if ("IntersectionObserver" in window) {
                if (scrollObserver) scrollObserver.disconnect();
                scrollObserver = new IntersectionObserver((entries) => {
                    entries.forEach(entry => {
                        if (entry.isIntersecting) {
                            entry.target.classList.add('is-visible');
                            scrollObserver.unobserve(entry.target);
                        }
                    });
                }, { threshold: 0.1 });
                elements.forEach(el => scrollObserver.observe(el));
            } else {
                elements.forEach(el => el.classList.add('is-visible'));
            }
        };
        const createFloatingHearts = () => {
            const container = document.querySelector('.floating-hearts');
            if (!container) return;
            container.innerHTML = '';
            for (let i = 0; i < 15; i++) {
                const heart = document.createElement('div');
                heart.innerHTML = '♥';
                heart.className = 'heart';
                heart.style.left = `${Math.random() * 100}%`;
                heart.style.animationDuration = `${5 + Math.random() * 10}s`;
                heart.style.animationDelay = `${Math.random() * 5}s`;
                heart.style.fontSize = `${10 + Math.random() * 20}px`;
                container.appendChild(heart);
            }
        };
        const timeAgo = (isoDate) => {
            if (!isoDate) return '';
            const seconds = Math.floor((new Date() - new Date(isoDate)) / 1000);
            if (seconds < 5) return "Baru sahaja";
            if (seconds < 60) return `${seconds} saat lalu`;
            const minutes = Math.floor(seconds / 60);
            if (minutes < 60) return `${minutes} minit lalu`;
            const hours = Math.floor(minutes / 60);
            if (hours < 24) return `${hours} jam lalu`;
            return `${Math.floor(hours / 24)} hari lalu`;
        };
        const generateCalendarLink = () => {
            const event = mainData.TextSettings[0];
            const format = (date) => new Date(date).toISOString().replace(/-|:|\.\d{3}/g, '');
            const url = new URL('https://www.google.com/calendar/render');
            url.searchParams.append('action', 'TEMPLATE');
            url.searchParams.append('text', event.CalendarTitle);
            url.searchParams.append('dates', `${format(event.CalendarStartTimeISO)}/${format(event.CalendarEndTimeISO)}`);
            url.searchParams.append('details', `Anda dijemput ke ${event.CalendarTitle}.`);
            url.searchParams.append('location', `${event.VenueName}, ${event.VenueAddress}`);
            return url.href;
        };
        const startCountdown = () => {
            if (state.countdownInterval) clearInterval(state.countdownInterval);
            const targetDate = new Date(mainData.TextSettings[0].CalendarStartTimeISO).getTime();
            const el = document.getElementById('countdown');
            if (!el) return;
            const update = () => {
                const distance = targetDate - new Date().getTime();
                if (distance < 0) {
                    clearInterval(state.countdownInterval);
                    el.innerHTML = "<p class='font-playfair text-xl'>Majlis telah berlangsung!</p>";
                    return;
                }
                const days = String(Math.floor(distance / 864e5)).padStart(2, '0');
                const hours = String(Math.floor((distance % 864e5) / 36e5)).padStart(2, '0');
                const minutes = String(Math.floor((distance % 36e5) / 6e4)).padStart(2, '0');
                const seconds = String(Math.floor((distance % 6e4) / 1e3)).padStart(2, '0');
                el.innerHTML = `<div class="text-center"><div class="font-playfair text-3xl">${days}</div><div class="text-xs">Hari</div></div><div class="text-center"><div class="font-playfair text-3xl">${hours}</div><div class="text-xs">Jam</div></div><div class="text-center"><div class="font-playfair text-3xl">${minutes}</div><div class="text-xs">Minit</div></div><div class="text-center"><div class="font-playfair text-3xl">${seconds}</div><div class="text-xs">Saat</div></div>`;
            };
            update();
            state.countdownInterval = setInterval(update, 1000);
        };
        const updateRsvpData = () => {
            const attending = mainData.RSVP.filter(r => r.Attendance === 'Hadir').reduce((total, rsvp) => total + (parseInt(rsvp.Pax, 10) || 1), 0);
            const notAttending = mainData.RSVP.filter(r => r.Attendance === 'Tidak Hadir').length;
            const ctx = document.getElementById('rsvpChart')?.getContext('2d');
            if (ctx) {
                if (state.rsvpChart) state.rsvpChart.destroy();
                state.rsvpChart = new Chart(ctx, { 
                    type: 'doughnut', 
                    data: { 
                        labels: ['Hadir (' + attending + ')', 'Tidak Hadir (' + notAttending + ')'], 
                        datasets: [{ 
                            data: [attending, notAttending], 
                            backgroundColor: ['#34D399', '#F87171'], 
                            borderColor: 'rgba(255,255,255,0)', 
                            borderWidth: 4 
                        }] 
                    }, 
                    options: { 
                        responsive: true, 
                        cutout: '70%', 
                        plugins: { 
                            legend: { 
                                position: 'bottom', 
                                labels: { 
                                    padding: 20, 
                                    font: { size: 14 } 
                                } 
                            } 
                        } 
                    } 
                });
            }
            renderWishes(state.currentWishesPage);
        };
        const updateTimestamps = () => {
            document.querySelectorAll('[data-timestamp]').forEach(el => {
                el.textContent = timeAgo(el.getAttribute('data-timestamp'));
            });
        };
        const renderWishes = (page, scrollToBottom = false) => {
            const listEl = document.getElementById('wishes-list');
            const paginationEl = document.getElementById('wishes-pagination');
            if (!listEl || !paginationEl) return;
            const allWishes = [...mainData.RSVP, ...mainData.WishesOnly, ...pendingWishes].filter(w => w.Wishes && w.Wishes.trim() !== '');
            allWishes.sort((a, b) => new Date(a.Timestamp) - new Date(b.Timestamp));
            const pageCount = Math.ceil(allWishes.length / WISHES_PER_PAGE) || 1;
            const currentPage = page > pageCount ? pageCount : (page || pageCount);
            state.currentWishesPage = currentPage;
            const start = (currentPage - 1) * WISHES_PER_PAGE;
            const end = start + WISHES_PER_PAGE;
            const paginatedWishes = allWishes.slice(start, end);
            listEl.innerHTML = paginatedWishes.length > 0 ? paginatedWishes.map(wish => `<div class="chat-bubble ${wish.pending ? 'pending' : ''} ${wish.failed ? 'failed' : ''}"><div class="flex justify-between items-center mb-1"><p class="font-semibold flex items-center ${wish.pending ? 'text-yellow-600' : wish.failed ? 'text-red-600' : 'text-blue-600'}">${wish.Name} ${!wish.pending && !wish.failed ? `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="ml-1.5 text-blue-500"><path d="M18 6 7 17l-5-5"/><path d="m22 10-7.5 7.5L13 16"/></svg>` : ''}</p><p class="text-xs text-slate-400" data-timestamp="${wish.Timestamp}">${timeAgo(wish.Timestamp)}</p></div><p class="text-slate-800 text-base break-words">${wish.Wishes}</p></div>`).join('') : '<p class="text-center text-slate-500 bg-white/70 rounded-full py-2">Jadilah yang pertama memberi ucapan!</p>';
            updateTimestamps();
            paginationEl.innerHTML = pageCount > 1 ? Array.from({ length: pageCount }, (_, i) => `<button data-page="${i+1}" class="w-7 h-7 text-xs rounded-full mx-1 ${i+1 === currentPage ? 'bg-white font-bold' : 'bg-white/50'}">${i+1}</button>`).join('') : '';
            if (scrollToBottom) {
                setTimeout(() => { listEl.scrollTop = listEl.scrollHeight; }, 100);
            }
            if (state.timeAgoInterval) clearInterval(state.timeAgoInterval);
            state.timeAgoInterval = setInterval(updateTimestamps, 60000);
        };
        const setupWishForm = () => {
            document.body.addEventListener('click', (e) => {
                if (e.target.matches('#wishes-pagination button')) {
                    renderWishes(parseInt(e.target.dataset.page), true);
                }
            });
            const form = document.getElementById('wish-form');
            form?.addEventListener('submit', (e) => {
                e.preventDefault();
                const nameInput = form.querySelector('#wish-name-input');
                const wishInput = form.querySelector('#wish-input');
                const submitBtn = form.querySelector('button[type="submit"]');
                if (nameInput.value.trim() === '' || wishInput.value.trim() === '') {
                    showToast('Sila isi nama dan ucapan anda.');
                    return;
                }
                const originalContent = submitBtn.innerHTML;
                submitBtn.innerHTML = '<div class="spinner"></div>';
                submitBtn.disabled = true;
                const wishPayload = { Name: nameInput.value.trim(), Wishes: wishInput.value.trim() };
                fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'addWish', payload: wishPayload }), headers: { 'Content-Type': 'application/json' } })
                    .then(res => res.json())
                    .then(res => {
                        if (res.result !== "success") throw new Error(res.error || "Unknown error");
                        wishPayload.Timestamp = new Date().toISOString();
                        mainData.WishesOnly.push(wishPayload);
                        saveDataToCache(mainData);
                        const lastPage = Math.ceil([...mainData.RSVP, ...mainData.WishesOnly].filter(w => w.Wishes && w.Wishes.trim() !== '').length / WISHES_PER_PAGE) || 1;
                        renderWishes(lastPage, true);
                        nameInput.value = '';
                        wishInput.value = '';
                        showToast('Ucapan anda telah dihantar!');
                    })
                    .catch(error => {
                        console.error('Error submitting wish:', error.message);
                        showToast('Gagal menghantar ucapan.');
                    })
                    .finally(() => {
                        submitBtn.innerHTML = originalContent;
                        submitBtn.disabled = false;
                    });
            });
        };
        const setupRsvpForm = () => {
            const form = document.getElementById('rsvpForm');
            if (!form) return;
            const paxSection = document.getElementById('pax-section');
            form.elements.Attendance.forEach(radio => radio.addEventListener('change', (e) => paxSection.classList.toggle('hidden', e.target.value !== 'Hadir')));
            form.addEventListener('submit', (e) => {
                e.preventDefault();
                if (!form.elements.Name.value.trim() || !form.elements.Attendance.value) {
                    showToast('Sila isi nama dan status kehadiran.');
                    return;
                }
                const submitBtn = form.querySelector('button[type="submit"]');
                const originalBtnText = submitBtn.innerText;
                submitBtn.innerHTML = '<div class="spinner mx-auto"></div>';
                submitBtn.disabled = true;
                const rsvpPayload = Object.fromEntries(new FormData(form).entries());
                fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'addRsvp', payload: rsvpPayload }), headers: { 'Content-Type': 'application/json' } })
                    .then(res => res.json())
                    .then(res => {
                        if (res.result !== "success") throw new Error(res.error || "Unknown error");
                        rsvpPayload.Timestamp = new Date().toISOString();
                        mainData.RSVP.push(rsvpPayload);
                        saveDataToCache(mainData);
                        updateRsvpData();
                        const responseEl = document.getElementById('rsvp-response');
                        const formEl = document.getElementById('rsvpForm');
                        formEl.classList.add('hidden');
                        responseEl.classList.remove('hidden');
                        const footerHTML = `<p class="text-xs text-slate-400 mt-8">Kad Digital ini dibina oleh <a href="https://b.my/bazlinj" target="_blank" class="font-semibold text-slate-500 hover:text-blue-600">@bazlinj</a></p>`;
                        if (rsvpPayload.Attendance === 'Tidak Hadir') {
                            responseEl.innerHTML = `<p class="mb-4">Terima kasih atas maklum balas anda.</p><div class="flex justify-center space-x-4"><button id="rsvp-close-btn" class="bg-slate-200 text-slate-800 font-bold py-3 px-6 rounded-full">Tutup</button><button id="go-to-gift-btn" class="bg-blue-600 text-white font-bold py-3 px-6 rounded-full">Kirim Hadiah</button></div>${footerHTML}`;
                            document.getElementById('go-to-gift-btn').addEventListener('click', () => { setActivePage('utama'); openDrawer('hadiah'); });
                            document.getElementById('rsvp-close-btn').addEventListener('click', () => { setActivePage('utama'); formEl.classList.remove('hidden'); responseEl.classList.add('hidden'); form.reset(); paxSection.classList.add('hidden'); });
                        } else {
                            responseEl.innerHTML = `<p class="mb-4">Terima kasih, ${rsvpPayload.Name}! Kehadiran anda telah direkodkan.</p><button id="rsvp-close-btn" class="bg-blue-600 text-white font-bold py-3 px-8 rounded-full">OK</button>${footerHTML}`;
                            document.getElementById('rsvp-close-btn').addEventListener('click', () => { setActivePage('utama'); formEl.classList.remove('hidden'); responseEl.classList.add('hidden'); form.reset(); paxSection.classList.add('hidden'); });
                        }
                    })
                    .catch(error => {
                        console.error('Error submitting RSVP:', error.message);
                        showToast('Gagal menghantar RSVP.');
                    })
                    .finally(() => {
                        submitBtn.innerText = originalBtnText;
                        submitBtn.disabled = false;
                    });
            });
        };
        const renderGiftList = () => {
            const listEl = document.getElementById('gift-list');
            if (!listEl) return;
            listEl.innerHTML = giftLinkData.map(item => `<a href="${item.url}" target="_blank" class="flex items-center bg-slate-100 p-4 rounded-xl hover:bg-slate-200 transition"><img src="${item.logo}" alt="${item.name}" class="w-10 h-10 object-contain mr-4" onerror="this.style.display='none'"><span class="font-semibold text-slate-700">${item.name}</span><svg class="w-5 h-5 ml-auto text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg></a>`).join('');
        };
        const renderContactList = () => {
            const listEl = document.getElementById('contact-list');
            if (!listEl) return;
            listEl.innerHTML = mainData.ContactList.map(contact => `<div class="flex items-center justify-between bg-slate-50 p-4 rounded-xl"><div><p class="font-semibold text-slate-800">${contact.Name}</p><p class="text-slate-500">${contact.PhoneNumber}</p></div><div class="flex items-center space-x-2"><a href="tel:${contact.PhoneNumber}" class="flex items-center justify-center w-10 h-10 bg-blue-100 text-blue-800 rounded-full hover:bg-blue-200 transition"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z" /></svg></a><a href="https://wa.me/6${contact.PhoneNumber.replace(/\D/g,'')}" target="_blank" class="flex items-center justify-center w-10 h-10 bg-green-100 text-green-800 rounded-full hover:bg-green-200 transition"><i class="bi bi-whatsapp"></i></a></div></div>`).join('');
        };
        
        const setupGallery = () => {
            const gallery = document.querySelector('.gallery-container');
            if (!gallery) return;
            const items = gallery.querySelectorAll('.gallery-item');
            const prevBtn = gallery.querySelector('.gallery-prev');
            const nextBtn = gallery.querySelector('.gallery-next');
            if (items.length <= 1) {
                if(prevBtn) prevBtn.style.display = 'none';
                if(nextBtn) nextBtn.style.display = 'none';
                return;
            }
            let currentIndex = 0;
            const showImage = (index) => {
                items.forEach((item, i) => {
                    item.style.opacity = i === index ? '1' : '0';
                });
            };
            
            const showNext = () => {
                currentIndex = (currentIndex + 1) % items.length;
                showImage(currentIndex);
            };

            const showPrev = () => {
                currentIndex = (currentIndex - 1 + items.length) % items.length;
                showImage(currentIndex);
            };

            if(state.galleryInterval) clearInterval(state.galleryInterval);
            state.galleryInterval = setInterval(showNext, 4000);

            nextBtn.addEventListener('click', () => {
                showNext();
                clearInterval(state.galleryInterval);
                state.galleryInterval = setInterval(showNext, 8000);
            });
            prevBtn.addEventListener('click', () => {
                showPrev();
                clearInterval(state.galleryInterval);
                state.galleryInterval = setInterval(showNext, 8000);
            });
        };

        const setupYouTubeAPI = () => {
            const tag = document.createElement('script');
            tag.src = "https://www.youtube.com/iframe_api";
            const firstScriptTag = document.getElementsByTagName('script')[0];
            if (firstScriptTag) {
                firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);
            } else {
                document.head.appendChild(tag);
            }
        };
        
        const createAudioPlayer = (songId) => {
            if (state.audioPlayer) return;
            state.audioPlayer = new YT.Player('audio-player', {
                videoId: songId,
                playerVars: { 'autoplay': 0, 'controls': 0, 'loop': 1, 'mute': 1, 'playsinline': 1, 'playlist': songId },
                events: { 'onReady': onAudioPlayerReady, 'onStateChange': onAudioPlayerStateChange }
            });
        };

        window.onYouTubeIframeAPIReady = () => {
            const audioSongId = mainData.Song?.[0]?.YoutubeID;
            if (audioSongId) {
                createAudioPlayer(audioSongId);
            }
        };

        function onAudioPlayerReady(event) {
            if (invitationOpened) {
                event.target.unMute();
                event.target.playVideo();
            }
        }
        
        function onAudioPlayerStateChange(event) {
            state.isMusicPlaying = event.data === YT.PlayerState.PLAYING;
            updateMusicButtonState();
        }
        
        init();
    });
    </script>
</body>
</html>